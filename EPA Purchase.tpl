___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "type": "TAG",
  "displayName": "Purchase EPA",
  "categories": ["CONVERSIONS","PERSONALIZATION"],
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "EPA Purchase",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Etiqueta de Purchase EPA",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "ecommerce",
    "displayName": "Ecommerce Variable",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "event",
    "displayName": "Event Variable",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "inpCategory",
    "displayName": "Enter a String for Regex Match",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const makeTableMap = require('makeTableMap');
const makeNumber = require('makeNumber');
const query = require('queryPermission');
const createQueue = require('createQueue');
const dataLayerPush = createQueue('dataLayer');
const createArgumentsQueue = require('createArgumentsQueue');
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const injectScript = require('injectScript');
const getTimestampMillis = require('getTimestampMillis');
const encodeUriComponent = require('encodeUriComponent');

var inpCategory = data.inpCategory;
var newArray = [];
var newVal = 0;
const ecommerce = data.ecommerce;
if(ecommerce != undefined){var items = data.ecommerce.items;}
var event = data.event;




if(event == 'gtm.js'){
  dataLayerPush({'event':'page_view_EPA_'+inpCategory});
}else if(event == 'purchase'){
ecommerce.shipping = makeNumber(ecommerce.shipping);
for(var i=0; i<items.length;i++){   
 if(items[i].item_category==undefined){
   items[i].item_category="";
 } 
  if(items[i].item_brand==undefined){
   items[i].item_brand="";
 } 
  if(items[i].item_name==undefined){
   items[i].item_name="";
 } 
  if(items[i].item_category.toLowerCase().match(inpCategory.toLowerCase())||items[i].item_brand.toLowerCase().match(inpCategory.toLowerCase())||items[i].item_name.toLowerCase().match(inpCategory.toLowerCase())){
    items[i].item_name = inpCategory + ' - ' + items[i].item_name;
    items[i].price = makeNumber(items[i].price);
    items[i].quantity = makeNumber(items[i].quantity);
    items[i].discount = makeNumber(items[i].discount);
    items[i].index = makeNumber(items[i].index);
    newArray.push(items[i]);
    newVal += (items[i].price-items[i].discount)*items[i].quantity;
  }
}
if(newArray.length>0){
  dataLayerPush({ecommerce:null});
dataLayerPush({'event':'purchase_EPA_'+inpCategory,ecommerce:{'term':inpCategory, 'value': ecommerce.shipping+newVal, 'currency': ecommerce.currency, 'transaction_id': ecommerce.transaction_id, 'affiliation': ecommerce.affiliation, 'tax':ecommerce.tax, 'shipping': ecommerce.shipping, 'coupon': ecommerce.coupon,'items':newArray} });  
}
  }

// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "newArray"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Untitled test 1
  code: |-
    const mockData = {
      // Mocked field values
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 9/7/2022, 3:38:08 PM


